<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>Reverse-engineering an Apparat RTC card for Y2K compliance - bombsquad.dev</title>
    <meta name="description" content="A super secret template post.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link href="/style/custom-style.css" type="text/css" rel="stylesheet">
    <meta name="theme-color" content="#161616">
</head>
<body>
<header>
    <div class="container border text-center pt-3">
    <p class="h1"><b>bombsquad.dev</b></p>
    <nav class ="nav justify-content-center">
        <a class="nav-link" href="/">Home</a>
        <a class="nav-link" href="/posts.html">Posts</a>
        <a class="nav-link" href="/posts/projects.html">Projects</a>
        <a class="nav-link" href="/posts/about.html">About</a>
    </nav>
</div>
</header>
<main>
<div class="container border pt-3">
    <div class="mx-auto" style="max-width: 80ch;">
        <div class="mx-auto d-flex align-items-center gap-2" style="max-width: 80ch;">
    <!-- Image box for posts. (optional) -->
    <div class="border bg-dark d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
        <img src="/images/post.png" alt="" class="position-relative" style="width: 48px; height: 48px; object-fit: scale-down; image-rendering: pixelated;" />
    </div>
    <!-- Box containing the post title on top, tags on the bottom. -->
    <div class="flex-grow-1 d-flex flex-column" style="">
        <!-- Name box, with optional inline description -->
        <p class="h3 mb-0">
            <span class="d-inline-flex align-items-baseline gap-2">
                <a href="/posts/clock.html" class="nav-link d-inline"><b>Reverse-engineering an Apparat RTC card for Y2K compliance</b></a>
            </span>
        </p>
        <!-- Date / tags -->
        <span>
            <span class="border rounded-5 text-bg-dark text-primary">&nbsp2026-02-12&nbsp</span>

            <span class="border rounded-5 text-bg-dark text-primary">&nbsp1886 words&nbsp</span>
            <span class="border rounded-5 text-bg-dark text-primary">&nbsp10 min. read&nbsp</span>
        </span>
    </div>
</div>
        <div class="pt-3"><p>The Compaq Portable that I've restored comes with a couple of
after-market additions, one of which is an RTC card from Apparat - the rather boringly named &quot;Clock Calendar Card&quot;.
Unfortunately, information about this card is quite difficult to come across
online, and all I have to work with is the original software, sourced from the original image of the Compaq's hard drive.
Oh, and the software isn't Y2K-compliant! The horror! Well, I guess it's time to patch it before the next millennium arrives...</p>
<hr />
<h3><strong>Some context</strong></h3>
<p>First, some context - what even is an 'RTC card'? The original IBM PC did not come with any
solution for storing the date and time after shutting off, requiring users
to enter the date and time on every boot. Therefore, aftermaket RTC (Real-Time Clock) cards
became popular - just copy the included software to your disk, add a line to <code>AUTOEXEC.BAT</code>, and the date and
time would automatically get set on boot, with the date and time being saved to the card, preserved with a battery backup.</p>
<p>This became less of an issue following the release of the IBM AT in 1984, which actually featured an on-board RTC controller with a battery backup.</p>
<hr />
<pre><code class="language-ibm">Current date is Tue  1-01-1980
Enter new date (mm-dd-yy): 
Current time is  0:00:10.98
Enter new time: _
</code></pre>
<p><em>A common sight for MS-DOS users without RTC cards.</em></p>
<hr />
<h3><strong>The Clock/Calendar card</strong></h3>
<p><img src="/images/apparat-card-front.jpg" alt="Apparat" />
This Compaq Portable that I've been restoring contains an &quot;Clock/Calendar&quot; card from a company called Apparat,
a manufacturer of accessories for many home computers of the 1980s. Unfortunately, this particular RTC card has
frustratingly little information available about it online. The only information I could find was an old archived
magazine article (PC Mag 1982-09 page 9) indicating that it was for sale for $129. (~$428.00 in 2026).<sup><a href="#user-content-fn-apparat-ad" id="user-content-fnref-apparat-ad" data-footnote-ref="" aria-describedby="footnote-label">1</a></sup></p>
<p>MS-DOS allows for a date to be set up to the year 2099, meaning it's already Y2K-compliant.
What happens when we attempt to initialize our RTC card with a date in the current year, 2026?</p>
<pre><code class="language-ibm">C:\&gt;DATE
Current date is Mon  2-16-2026
Enter new date (mm-dd-yy):

C:\&gt;SETCLOCK INITIAL

Clock/Calendar Routine V1.14
Copyright 1982 Apparat, Inc.
02/16/99 20:39:34


Is this correct? (Y/N) _
</code></pre>
<p>...no, that's not correct! What's going on here?</p>
<hr />
<h3><strong>Debugging!</strong></h3>
<p>Let's first figure out how our program is actually getting the date in the first place.
In MS-DOS, this is actually pretty easy! In assembly language, we can execute system functions,
conveniently provided to us by MS-DOS, just by loading a byte into the <code>AH</code> register and calling <code>int 21h</code>.
The byte specified in the <code>AH</code> register determines which function is called.
We're interested in instances of these calls where <code>AH</code> is set to either <code>2Ah</code> or <code>2Bh</code>.
These represent the functions for getting the system time, and setting the system time, respectively.</p>
<blockquote>
<p><strong>2Ah - Get date</strong></p>
<p>Returns in registers:</p>
<ul>
<li>AL - day of the week</li>
<li>CX - year, between 1980 and 2099</li>
<li>DH - month, between 1 and 12</li>
<li>DL - day of the month, between 1 and 31</li>
</ul>
</blockquote>
<blockquote>
<p><strong>2Bh - Set date</strong></p>
<p>Parameters supplied to registers:</p>
<ul>
<li>CX - year, between 1980 and 2099</li>
<li>DH - month, between 1 and 12</li>
<li>DL - day of the month, between 1 and 31</li>
</ul>
</blockquote>
<p>Just as a side note, the year here is actually a 16-bit value, stored in the <code>CX</code> register.
...does this mean that a year up to 65535 can be stored? Nope, if you attempt to supply
a date beyond 2099 (0x833 in hex), <code>int 21h</code> will fail and return <code>0xFF</code> in register <code>AL</code>.</p>
<p>We can use the MS-DOS program <code>DEBUG</code> to disassemble (in its words - <em>unassemble</em>) the machine language,
and we do indeed end up finding a single call to <code>int 21h</code> with parameter <code>2Ah</code> here:</p>
<pre><code class="language-ibm">-u 02e9
101A:02E9 BF6E01        MOV     DI,016E
101A:02EC B42A          MOV     AH,2A
101A:02EE CD21          INT     21
101A:02F0 895503        MOV     [DI+03],DX
101A:02F3 81E96C07      SUB     CX,076C
101A:02F7 80F963        CMP     CL,63
101A:02FA 7202          JB      02FE
101A:02FC B163          MOV     CL,63
</code></pre>
<p>We can then execute the program and break right after the call to <code>int 21h</code>, and inspect the registers:</p>
<pre><code class="language-ibm">-g 02f0
AX=2A01  BX=0000  CX=07EA  DX=0210
SP=FFFE  BP=0000  SI=0066  DI=016E
DS=101A  ES=101A  SS=101A  CS=101A  
IP=02F0   NV UP EI PL ZR NA PE NC
101A:02F0 895503        MOV     [DI+03],DX       DS:0171=4D44
</code></pre>
<p>Looking at our above reference on this particular <code>int 21h</code> call, we do indeed see that the year is stored in register <code>CX</code> as <code>07EAh</code> - 2026!</p>
<p>So, everything is working correctly on the MS-DOS side, but a closer look at the assembly code above shows
that we're subtracing a suspicious-looking constant from <code>CX</code> - <code>076C</code> - which happens to be 1900!</p>
<p>Yup, it's just converting the year to a value representing 'number of years from 1900',
and the code we're looking at is also, from lines <code>02F7</code> to <code>02FC</code>, capping this number to 99.</p>
<p>In fact, a quick search for our constant <code>6c 07</code> using <code>DEBUG</code> shows another use:</p>
<pre><code class="language-ibm">-s cs:0100 0300 6c 07
101A:02C4 
101A:02F5 
-u 02c3
101A:02C3 B96C07        MOV     CX,076C  
101A:02C6 024C05        ADD     CL,[SI+05]  
</code></pre>
<p>It's used in the portion of the code where the data is being read back from the card.
So, we can just adjust this constant to <code>0x7D0</code> (2000), and all of our issues should be solved!
Now we're storing the year as an offset from the year 2000, rather than the year 1900.</p>
<pre><code class="language-ibm">C:\&gt;SETCLOCK INITIAL

Clock/Calendar Routine V1.14
Copyright 1982 Apparat, Inc.
02/16/26 21:10:15


Is this correct? (Y/N) _
</code></pre>
<p>Finally, it's correct... for the next 74 years, anyways.</p>
<hr />
<h3><strong>Digging a little deeper</strong></h3>
<p><img src="/images/apparat-card-m5832.jpg" alt="M583" /></p>
<p>So, we swapped out a constant and patched this software for the next three quarters of a century.
Is this the best possible solution, or can we actually come up with a better solution
with the hardware we have?</p>
<p>Wait, what specific hardware do we have, anyways?
If you take a look at the image of the Clock / Calendar card in the previous section,
you'll notice it almost entirely consists of off-the-shelf 7400-series components, with one stand-out - the OKI Semiconductors M5832.</p>
<p>As per the data sheet<sup><a href="#user-content-fn-m5832" id="user-content-fnref-m5832" data-footnote-ref="" aria-describedby="footnote-label">2</a></sup>, this chip is an RTC IC with a 4-bit address and data bus.
With this size, we would normally anticipate a total capacity of 256 bits, but the function table
in the data sheet indicates that the internal counters have some fairly strict data limitations.
Only 3 bits are used for the 10s place of the second counter, and only one bit is used for the 10s place of the month counter.</p>
<p>How exactly does the x86 processor interact with this card?
The software uses the <code>IN</code> and <code>OUT</code> instructions to communicate with the card on IO port <code>0x2A2</code>.
The software also specifically uses a routine at <code>CS:037C</code> to add a delay between calls to <code>OUT</code>, by using the <code>LOOP</code> instruction.
The specific number of times the <code>LOOP</code> instruction is called is 550 times, which resolves to an approximate delay of 580 microseconds on a 4.77Mhz-clocked 8088.<sup><a href="#user-content-fn-x86" id="user-content-fnref-x86" data-footnote-ref="" aria-describedby="footnote-label">3</a></sup></p>
<p>Any read or write access to the card also seems to stop the time from proceeding, so the byte <code>0x00</code> needs to be sent in order to restore operation.</p>
<p>I've created a table of operations based on my observations:</p>
<table>
<thead>
<tr>
<th>Counter</th>
<th>Read</th>
<th>Write</th>
</tr>
</thead>
<tbody>
<tr>
<td>S1</td>
<td><code>0x50</code></td>
<td><code>0x10</code></td>
</tr>
<tr>
<td>S10</td>
<td><code>0x51</code></td>
<td><code>0x11</code></td>
</tr>
<tr>
<td>MI1</td>
<td><code>0x52</code></td>
<td><code>0x12</code></td>
</tr>
<tr>
<td>MI10</td>
<td><code>0x53</code></td>
<td><code>0x13</code></td>
</tr>
<tr>
<td>H1</td>
<td><code>0x54</code></td>
<td><code>0x14</code></td>
</tr>
<tr>
<td>H10</td>
<td><code>0x55</code></td>
<td><code>0x15</code></td>
</tr>
<tr>
<td>W</td>
<td><code>0x56</code></td>
<td><code>0x16</code></td>
</tr>
<tr>
<td>D1</td>
<td><code>0x57</code></td>
<td><code>0x17</code></td>
</tr>
<tr>
<td>D10</td>
<td><code>0x58</code></td>
<td><code>0x18</code></td>
</tr>
<tr>
<td>MO1</td>
<td><code>0x59</code></td>
<td><code>0x19</code></td>
</tr>
<tr>
<td>MO10</td>
<td><code>0x5A</code></td>
<td><code>0x1A</code></td>
</tr>
<tr>
<td>Y1</td>
<td><code>0x5B</code></td>
<td><code>0x1B</code></td>
</tr>
<tr>
<td>Y10</td>
<td><code>0x5C</code></td>
<td><code>0x1C</code></td>
</tr>
<tr>
<td>End</td>
<td><code>0x00</code></td>
<td><code>0x00</code></td>
</tr>
</tbody>
</table>
<p>You might think that having to split our date and time numbers into their 10s-place and 1s-place digits might involve a little bit of work,
but actually, the x86 instruction set comes to save the day!
The x86 provides us with some instructions to easily communicate with the M5832, or any device expecting BCD.
We can use the <code>AAM</code> instruction to convert a byte in <code>AL</code> to two BCD-encoded bytes,
and we can use the <code>AAD</code> instruction to convert two bytes in <code>AX</code> to a single hexadecimal-encoded value in <code>AX</code>.</p>
<p>As an example for how this works, we can consider the number of years since 2000 - 26, or <code>0x1A</code> in hex.
Loading <code>0x1A</code> into our <code>AX</code> register and then running the <code>AAM</code> instruction fills <code>AX</code> with the value <code>0x0206</code>.
Then, we just need to send <code>0x1B</code> to the M5832, followed by the value in <code>AL</code>, and then <code>0x1C</code> for the Y10 counter, and value in <code>AH</code>. Finally, sending <code>0x00</code> will have set the year properly.</p>
<p>This works in reverse too! If we want to read the year back, we just read the value at <code>0x5B</code> and <code>0x5C</code>.
However, since this is a 4-bit value, the top 4 bits of the value are junk and need to be masked out by calling <code>AND</code> with a value of <code>0xF</code>.
Once this is done, moving both of the values back to the <code>AX</code> register, and then running the <code>AAD</code> instruction will restore our value of <code>0x1C</code>.</p>
<hr />
<h2><strong>Final thoughts</strong></h2>
<p>There's actually an oddity in the above table that you might have noticed - counter 'W' - for day of the week!
The pattern determining what the days of the week are each month actually does not repeat every century, it repeats every 400 years!</p>
<p>Therefore, the 16th of February in 2026 is a Monday, and the 16th of February in 1926 is a Tuesday.</p>
<p>This entire thing is foiled, isn't it...?</p>
<p>Actually, no, everything is fine - the original Apparat software completely ignores this counter and never assigns any value to it.
It also doesn't need to read from the value either, because MS-DOS automatically assigns the date of the week for you -
if you'll notice above, the <code>int 21h</code> call for setting the date does not take a day of the week as a parameter.</p>
<p>What this <em>does</em> mean is that we can actually use this day-of-the-week counter as a century counter! We have about three bits of precision to work with,
so if we just write our own clock-setting software that takes advantage of this, we can solve this issue for the next 800 years!</p>
<p>... actually, the FAT filesystem will probably need to be patched first, since the way <em>that</em> stores years only leaves us until 2107.</p>
<p>I'll leave that as an exercise for the reader!</p>
<hr />
<h2><strong>The software</strong></h2>
<p>I've uploaded the original <code>SETCLOCK.COM</code> and my patched <code>SETCLK21.COM</code> variant to Archive.org, for anyone who happens to have the same RTC card!
Find it here: [placeholder]</p>
<p>Thanks for reading!</p>
<section data-footnotes="" class="footnotes"><h2 id="footnote-label" class="sr-only">Footnotes</h2>
<ol>
<li id="user-content-fn-apparat-ad">
<p>Apparat, Inc. <em>PC Magazine</em>, vol. 1, no. 5, Sept. 1982, <a href="https://archive.org/details/PC-Mag-1982-09">https://archive.org/details/PC-Mag-1982-09</a> <a href="#user-content-fnref-apparat-ad" data-footnote-backref="" aria-label="Back to content" class="data-footnote-backref">↩</a></p>
</li>
<li id="user-content-fn-m5832">
<p>OKI Semiconductor, <em>MSM5832 MICROPROCESSOR REAL-TIME CLOCK/CALENDAR</em>, Dec. 1983, <a href="https://deramp.com/downloads/mfe_archive/050-Component%20Specifications/OKI/Oki%20MM5832%20RTC.pdf">https://deramp.com/downloads/mfe_archive/050-Component%20Specifications/OKI/Oki%20MM5832%20RTC.pdf</a> <a href="#user-content-fnref-m5832" data-footnote-backref="" aria-label="Back to content" class="data-footnote-backref">↩</a></p>
</li>
<li id="user-content-fn-x86">
<p>Intel Corporation, <em>iAPX 86/88, 186/188 User's Manual, Programmer's Reference</em>, May. 1983, <a href="https://bitsavers.trailing-edge.com/components/intel/80186/210911-001_iAPX86_88_186_188_Programmers_Reference_1983.pdf">https://bitsavers.trailing-edge.com/components/intel/80186/210911-001_iAPX86_88_186_188_Programmers_Reference_1983.pdf</a> <a href="#user-content-fnref-x86" data-footnote-backref="" aria-label="Back to content" class="data-footnote-backref">↩</a></p>
</li>
</ol>
</section>
</div>
    </div>
</div>
</main>
<footer>
    <div class="container border text-center pt-3">
        <div class="mx-auto" style="max-width: 80ch;">
            <p>(c) 2026 bombsquad.dev</p>
        </div>
    </div>
</footer>
</body>
</html>